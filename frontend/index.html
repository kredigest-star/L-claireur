<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L'Éclaireur | Journal d'information</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+Pro:wght@400;600&family=Source+Serif+Pro:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Search Styles */
        .search-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding-top: 10vh;
        }
        .search-overlay.active {
            display: flex;
        }
        .search-container {
            width: 90%;
            max-width: 700px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .search-header {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e5e5e5;
        }
        .search-header i {
            font-size: 1.25rem;
            color: #999;
            margin-right: 1rem;
        }
        .search-header input {
            flex: 1;
            border: none;
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 1.125rem;
            outline: none;
        }
        .search-header input::placeholder {
            color: #999;
        }
        .search-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            padding: 0.5rem;
        }
        .search-close:hover {
            color: #333;
        }
        .search-results {
            max-height: 60vh;
            overflow-y: auto;
        }
        .search-result {
            display: flex;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #f0f0f0;
            text-decoration: none;
            color: inherit;
            transition: background 0.2s;
        }
        .search-result:hover {
            background: #f9f9f9;
        }
        .search-result-image {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            flex-shrink: 0;
        }
        .search-result-content {
            flex: 1;
        }
        .search-result-category {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #326891;
        }
        .search-result-title {
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            font-weight: 600;
            color: #121212;
            margin: 0.25rem 0;
        }
        .search-result-meta {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.75rem;
            color: #999;
        }
        .search-no-results {
            padding: 3rem;
            text-align: center;
            color: #999;
            font-family: 'Source Sans Pro', sans-serif;
        }
        .search-no-results i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }
        .search-loading {
            padding: 2rem;
            text-align: center;
            color: #999;
        }
        .search-loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        /* Article Cards */
        .article-card {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 4px;
            overflow: hidden;
            transition: box-shadow 0.3s;
        }
        .article-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .article-card-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f0f0f0;
        }
        .article-card-content {
            padding: 1.25rem;
        }
        .article-card-category {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #326891;
            margin-bottom: 0.5rem;
        }
        .article-card-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 0.75rem;
            color: #121212;
        }
        .article-card-title a {
            color: inherit;
            text-decoration: none;
        }
        .article-card-title a:hover {
            text-decoration: underline;
        }
        .article-card-excerpt {
            font-family: 'Source Serif Pro', serif;
            font-size: 0.95rem;
            color: #555;
            line-height: 1.5;
            margin-bottom: 1rem;
        }
        .article-card-meta {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.8rem;
            color: #999;
        }
        .article-card-author {
            font-weight: 600;
            color: #666;
        }
        .article-card-stats {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #999;
        }
        .article-card-stats span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .articles-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        @media (max-width: 992px) {
            .articles-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 576px) {
            .articles-grid {
                grid-template-columns: 1fr;
            }
        }
        .no-articles {
            text-align: center;
            padding: 3rem;
            color: #999;
            font-family: 'Source Sans Pro', sans-serif;
        }
        .no-articles i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }
        .hero-article {
            cursor: pointer;
        }
        .loading {
            text-align: center;
            padding: 2rem;
            color: #999;
        }
        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Category Sections */
        .category-section {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 2px solid #121212;
        }
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .category-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: #121212;
        }
        .category-link {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.875rem;
            color: #326891;
            text-decoration: none;
        }
        .category-link:hover {
            text-decoration: underline;
        }
        .category-articles {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }
        @media (max-width: 992px) {
            .category-articles {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 576px) {
            .category-articles {
                grid-template-columns: 1fr;
            }
        }
        .category-card {
            display: flex;
            flex-direction: column;
        }
        .category-card-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 0.75rem;
        }
        .category-card-title {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.9375rem;
            font-weight: 600;
            line-height: 1.3;
            color: #121212;
        }
        .category-card-title a {
            color: inherit;
            text-decoration: none;
        }
        .category-card-title a:hover {
            text-decoration: underline;
        }
        .category-card-date {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.25rem;
        }

        /* Most Read Section */
        .most-read-section {
            margin-top: 3rem;
            padding: 2rem;
            background: #f9f9f9;
            border-radius: 8px;
        }
        .most-read-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #121212;
        }
        .most-read-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .most-read-item {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }
        .most-read-number {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            color: #326891;
            line-height: 1;
            min-width: 2rem;
        }
        .most-read-content {
            flex: 1;
        }
        .most-read-item-title {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.9375rem;
            font-weight: 600;
            line-height: 1.3;
        }
        .most-read-item-title a {
            color: #121212;
            text-decoration: none;
        }
        .most-read-item-title a:hover {
            text-decoration: underline;
        }
        .most-read-meta {
            font-family: 'Source Sans Pro', sans-serif;
            font-size: 0.75rem;
            color: #999;
            margin-top: 0.25rem;
        }

        /* Profile Link */
        .user-profile-link {
            color: #326891;
            text-decoration: none;
            font-weight: 600;
        }
        .user-profile-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Search Overlay -->
    <div class="search-overlay" id="search-overlay">
        <div class="search-container">
            <div class="search-header">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Rechercher des articles...">
                <button class="search-close" onclick="closeSearch()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="search-results" id="search-results">
                <div class="search-no-results">
                    <i class="fas fa-search"></i>
                    <p>Commencez à taper pour rechercher</p>
                </div>
            </div>
        </div>
    </div>

    <div class="top-bar">
        <div class="container">
            <span class="date" id="current-date"></span>
            <span class="separator">|</span>
            <span class="edition">Édition Francophone</span>
        </div>
    </div>

    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="header-left">
                    <button class="menu-btn"><i class="fas fa-bars"></i></button>
                    <button class="search-btn" onclick="openSearch()"><i class="fas fa-search"></i></button>
                </div>
                <div class="header-center">
                    <a href="index.html" class="logo">
                        <span class="logo-text">L'Éclaireur</span>
                    </a>
                    <p class="tagline">La lumière sur l'actualité</p>
                </div>
                <div class="header-right" id="auth-buttons">
                    <a href="login.html" class="btn-auth">Connexion</a>
                    <a href="register.html" class="btn-subscribe">S'abonner</a>
                </div>
            </div>
        </div>
    </header>

    <nav class="main-nav">
        <div class="container">
            <ul class="nav-list">
                <li><a href="index.html" class="nav-link active">Accueil</a></li>
                <li><a href="index.html?cat=politique" class="nav-link">Politique</a></li>
                <li><a href="index.html?cat=monde" class="nav-link">Monde</a></li>
                <li><a href="index.html?cat=economie" class="nav-link">Économie</a></li>
                <li><a href="index.html?cat=sciences" class="nav-link">Sciences</a></li>
                <li><a href="index.html?cat=culture" class="nav-link">Culture</a></li>
                <li><a href="index.html?cat=sports" class="nav-link">Sports</a></li>
            </ul>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <!-- Hero Section -->
            <section class="hero-section" id="hero-section">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Chargement...</p>
                </div>
            </section>

            <!-- Articles Grid -->
            <section class="news-section">
                <div class="section-header">
                    <h2 class="section-title" id="section-title">Actualités</h2>
                </div>
                <div class="articles-grid" id="articles-container">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                    </div>
                </div>
            </section>

            <!-- Most Read Section -->
            <section class="most-read-section" id="most-read-section" style="display: none;">
                <h2 class="most-read-title"><i class="fas fa-fire"></i> Les plus lus</h2>
                <div class="most-read-list" id="most-read-list"></div>
            </section>

            <!-- Category Sections (only on homepage) -->
            <div id="category-sections"></div>
        </div>
    </main>

    <section class="newsletter-section">
        <div class="container">
            <div class="newsletter-content">
                <div class="newsletter-text">
                    <h3>Restez éclairé</h3>
                    <p>Recevez l'essentiel de l'actualité chaque matin.</p>
                </div>
                <form class="newsletter-form" id="newsletter-form">
                    <input type="email" placeholder="Votre email" required>
                    <button type="submit">S'inscrire</button>
                </form>
            </div>
        </div>
    </section>

    <footer class="main-footer">
        <div class="container">
            <div class="footer-brand">
                <span class="footer-logo">L'Éclaireur</span>
                <p>La lumière sur l'actualité</p>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 L'Éclaireur. Tous droits réservés.</p>
            </div>
        </div>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/menu.js"></script>
    <script>
        // Initialiser Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let allArticles = [];

        // Date du jour
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('fr-FR', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });

        // Récupérer la catégorie depuis l'URL
        const urlParams = new URLSearchParams(window.location.search);
        const selectedCategory = urlParams.get('cat');

        // Mettre à jour le titre et la navigation
        if (selectedCategory) {
            const categoryNames = {
                'politique': 'Politique',
                'monde': 'Monde',
                'economie': 'Économie',
                'sciences': 'Sciences',
                'culture': 'Culture',
                'sports': 'Sports'
            };
            document.getElementById('section-title').textContent = categoryNames[selectedCategory] || 'Actualités';
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.href.includes(`cat=${selectedCategory}`)) {
                    link.classList.add('active');
                }
            });
        }

        // ==================== SEARCH FUNCTIONS ====================
        function openSearch() {
            document.getElementById('search-overlay').classList.add('active');
            document.getElementById('search-input').focus();
            document.body.style.overflow = 'hidden';
        }

        function closeSearch() {
            document.getElementById('search-overlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close search on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeSearch();
        });

        // Close search on overlay click
        document.getElementById('search-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'search-overlay') closeSearch();
        });

        // Search input handler
        let searchTimeout;
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                document.getElementById('search-results').innerHTML = `
                    <div class="search-no-results">
                        <i class="fas fa-search"></i>
                        <p>Tapez au moins 2 caractères</p>
                    </div>
                `;
                return;
            }

            document.getElementById('search-results').innerHTML = `
                <div class="search-loading">
                    <i class="fas fa-spinner"></i>
                </div>
            `;

            searchTimeout = setTimeout(() => searchArticles(query), 300);
        });

        function searchArticles(query) {
            const resultsContainer = document.getElementById('search-results');
            const queryLower = query.toLowerCase();

            // Filter from cached articles
            const results = allArticles.filter(article => {
                const titleMatch = article.title && article.title.toLowerCase().includes(queryLower);
                const contentMatch = article.content && article.content.toLowerCase().includes(queryLower);
                const authorMatch = (article.authorDisplayName || article.authorName || '').toLowerCase().includes(queryLower);
                const excerptMatch = article.excerpt && article.excerpt.toLowerCase().includes(queryLower);
                return titleMatch || contentMatch || authorMatch || excerptMatch;
            });

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="search-no-results">
                        <i class="fas fa-search"></i>
                        <p>Aucun résultat pour "${query}"</p>
                    </div>
                `;
                return;
            }

            resultsContainer.innerHTML = results.slice(0, 10).map(article => {
                const date = article.createdAt ? formatDate(article.createdAt.toDate()) : '';
                const image = article.image || 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=200';
                
                return `
                    <a href="article.html?id=${article.id}" class="search-result">
                        <img src="${image}" alt="${article.title}" class="search-result-image" onerror="this.src='https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=200'">
                        <div class="search-result-content">
                            <div class="search-result-category">${getCategoryName(article.category)}</div>
                            <div class="search-result-title">${highlightText(article.title, query)}</div>
                            <div class="search-result-meta">Par ${article.authorDisplayName || article.authorName || 'Auteur'} • ${date}</div>
                        </div>
                    </a>
                `;
            }).join('');
        }

        function highlightText(text, query) {
            if (!text) return '';
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        // ==================== LOAD ARTICLES ====================
        async function loadArticles() {
            try {
                // Requête simple sans orderBy pour éviter les problèmes d'index
                let snapshot;
                
                if (selectedCategory) {
                    snapshot = await db.collection('articles')
                        .where('status', '==', 'published')
                        .where('category', '==', selectedCategory)
                        .get();
                } else {
                    snapshot = await db.collection('articles')
                        .where('status', '==', 'published')
                        .get();
                }
                
                const articles = [];
                snapshot.forEach(doc => {
                    articles.push({ id: doc.id, ...doc.data() });
                });

                // Trier par date côté client (plus récent en premier)
                articles.sort((a, b) => {
                    const dateA = a.createdAt ? a.createdAt.toDate().getTime() : 0;
                    const dateB = b.createdAt ? b.createdAt.toDate().getTime() : 0;
                    return dateB - dateA;
                });

                allArticles = articles; // Cache pour la recherche
                displayArticles(articles);
                
                // Charger les sections uniquement sur la page d'accueil
                if (!selectedCategory) {
                    loadMostRead();
                    loadCategorySections();
                }

            } catch (error) {
                console.error('Erreur chargement articles:', error);
                document.getElementById('hero-section').innerHTML = '';
                document.getElementById('articles-container').innerHTML = `
                    <div class="no-articles" style="grid-column: 1/-1;">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Erreur lors du chargement des articles</p>
                        <p style="font-size: 0.8rem; color: #999;">${error.message}</p>
                    </div>
                `;
            }
        }

        function displayArticles(articles) {
            const heroSection = document.getElementById('hero-section');
            const articlesContainer = document.getElementById('articles-container');

            if (articles.length === 0) {
                heroSection.innerHTML = '';
                articlesContainer.innerHTML = `
                    <div class="no-articles" style="grid-column: 1/-1;">
                        <i class="fas fa-newspaper"></i>
                        <p>Aucun article publié pour le moment</p>
                        <p style="font-size: 0.9rem;">Revenez bientôt !</p>
                    </div>
                `;
                return;
            }

            // Article principal (Hero)
            const heroArticle = articles[0];
            const heroDate = heroArticle.createdAt ? formatDate(heroArticle.createdAt.toDate()) : 'Récent';
            const heroImage = heroArticle.image || 'https://images.unsplash.com/photo-1495020689067-958852a7765e?w=1200';
            const heroLikes = heroArticle.likes || 0;
            const heroViews = heroArticle.views || 0;

            heroSection.innerHTML = `
                <article class="hero-article" onclick="window.location.href='article.html?id=${heroArticle.id}'">
                    <div class="hero-image">
                        <img src="${heroImage}" alt="${heroArticle.title}" onerror="this.src='https://images.unsplash.com/photo-1495020689067-958852a7765e?w=1200'">
                    </div>
                    <div class="hero-content">
                        <span class="category-tag">${getCategoryName(heroArticle.category)}</span>
                        <h1 class="hero-title">${heroArticle.title}</h1>
                        <p class="hero-excerpt">${heroArticle.excerpt || truncateText(heroArticle.content, 200)}</p>
                        <div class="hero-meta">
                            <span class="author">Par ${heroArticle.authorDisplayName || heroArticle.authorName || 'Auteur'}</span>
                            ${heroArticle.authorProfession ? `<span class="profession">, ${heroArticle.authorProfession}</span>` : ''}
                            <span class="date"> • ${heroDate}</span>
                            <span style="margin-left: 1rem; color: #999;">
                                <i class="fas fa-heart"></i> ${heroLikes} 
                                <i class="fas fa-eye" style="margin-left: 0.5rem;"></i> ${heroViews}
                            </span>
                        </div>
                    </div>
                </article>
            `;

            // Autres articles
            const otherArticles = articles.slice(1);
            
            if (otherArticles.length === 0) {
                articlesContainer.innerHTML = `
                    <div class="no-articles" style="grid-column: 1/-1;">
                        <p>Plus d'articles à venir...</p>
                    </div>
                `;
                return;
            }

            articlesContainer.innerHTML = otherArticles.map(article => {
                const date = article.createdAt ? formatDate(article.createdAt.toDate()) : 'Récent';
                const image = article.image || 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=600';
                const likes = article.likes || 0;
                const views = article.views || 0;
                
                return `
                    <article class="article-card">
                        <img src="${image}" alt="${article.title}" class="article-card-image" 
                             onerror="this.src='https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=600'">
                        <div class="article-card-content">
                            <div class="article-card-category">${getCategoryName(article.category)}</div>
                            <h3 class="article-card-title">
                                <a href="article.html?id=${article.id}">${article.title}</a>
                            </h3>
                            <p class="article-card-excerpt">${article.excerpt || truncateText(article.content, 100)}</p>
                            <div class="article-card-meta">
                                <span class="article-card-author">${article.authorDisplayName || article.authorName || 'Auteur'}</span>
                                ${article.authorProfession ? `, ${article.authorProfession}` : ''}
                                <span> • ${date}</span>
                            </div>
                            <div class="article-card-stats">
                                <span><i class="fas fa-heart"></i> ${likes}</span>
                                <span><i class="fas fa-eye"></i> ${views}</span>
                            </div>
                        </div>
                    </article>
                `;
            }).join('');
        }

        // ==================== MOST READ ====================
        async function loadMostRead() {
            try {
                const snapshot = await db.collection('articles')
                    .where('status', '==', 'published')
                    .get();

                if (snapshot.empty) return;

                const articles = [];
                snapshot.forEach(doc => {
                    articles.push({ id: doc.id, ...doc.data() });
                });

                // Trier par vues côté client
                articles.sort((a, b) => (b.views || 0) - (a.views || 0));
                const topArticles = articles.slice(0, 5);

                if (topArticles.length === 0) return;

                const container = document.getElementById('most-read-list');
                document.getElementById('most-read-section').style.display = 'block';

                container.innerHTML = topArticles.map((article, index) => {
                    const views = article.views || 0;
                    return `
                        <div class="most-read-item">
                            <span class="most-read-number">${index + 1}</span>
                            <div class="most-read-content">
                                <h3 class="most-read-item-title">
                                    <a href="article.html?id=${article.id}">${article.title}</a>
                                </h3>
                                <div class="most-read-meta">
                                    ${getCategoryName(article.category)} • ${views} vues
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading most read:', error);
            }
        }

        // ==================== CATEGORY SECTIONS ====================
        async function loadCategorySections() {
            const categories = ['politique', 'monde', 'economie', 'sciences', 'culture', 'sports'];
            const container = document.getElementById('category-sections');
            
            for (const category of categories) {
                try {
                    const snapshot = await db.collection('articles')
                        .where('status', '==', 'published')
                        .where('category', '==', category)
                        .get();

                    if (snapshot.empty) continue;

                    const articles = [];
                    snapshot.forEach(doc => {
                        articles.push({ id: doc.id, ...doc.data() });
                    });

                    // Trier par date côté client
                    articles.sort((a, b) => {
                        const dateA = a.createdAt ? a.createdAt.toDate().getTime() : 0;
                        const dateB = b.createdAt ? b.createdAt.toDate().getTime() : 0;
                        return dateB - dateA;
                    });

                    const topArticles = articles.slice(0, 4);

                    const articlesHtml = topArticles.map(article => {
                        const date = article.createdAt ? formatDate(article.createdAt.toDate()) : '';
                        const image = article.image || 'https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=300';
                        
                        return `
                            <div class="category-card">
                                <img src="${image}" alt="${article.title}" class="category-card-image" onerror="this.src='https://images.unsplash.com/photo-1504711434969-e33886168f5c?w=300'">
                                <h3 class="category-card-title">
                                    <a href="article.html?id=${article.id}">${article.title}</a>
                                </h3>
                                <div class="category-card-date">${date}</div>
                            </div>
                        `;
                    }).join('');

                    container.innerHTML += `
                        <section class="category-section">
                            <div class="category-header">
                                <h2 class="category-title">${getCategoryName(category)}</h2>
                                <a href="index.html?cat=${category}" class="category-link">Voir tout <i class="fas fa-arrow-right"></i></a>
                            </div>
                            <div class="category-articles">
                                ${articlesHtml}
                            </div>
                        </section>
                    `;

                } catch (error) {
                    console.error(`Error loading ${category}:`, error);
                }
            }
        }

        // ==================== HELPERS ====================
        function getCategoryName(category) {
            const names = {
                'politique': 'Politique',
                'monde': 'Monde',
                'economie': 'Économie',
                'sciences': 'Sciences',
                'culture': 'Culture',
                'sports': 'Sports'
            };
            return names[category] || category || 'Actualités';
        }

        function formatDate(date) {
            if (!date) return '';
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (hours < 1) return 'À l\'instant';
            if (hours < 24) return `Il y a ${hours}h`;
            if (days === 1) return 'Hier';
            if (days < 7) return `Il y a ${days} jours`;
            
            return date.toLocaleDateString('fr-FR', { 
                day: 'numeric', 
                month: 'long',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            // Remove HTML tags
            const plainText = text.replace(/<[^>]*>/g, '');
            if (plainText.length <= maxLength) return plainText;
            return plainText.substring(0, maxLength).trim() + '...';
        }

        // Newsletter
        document.getElementById('newsletter-form').addEventListener('submit', (e) => {
            e.preventDefault();
            alert('Merci pour votre inscription !');
            e.target.reset();
        });

        // ==================== INIT ====================
        loadArticles();
    </script>
</body>
</html>
